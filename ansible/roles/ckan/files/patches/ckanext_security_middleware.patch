From 74f78865b8825c91d1dfe6b189228f4b975610a3 Mon Sep 17 00:00:00 2001
From: Tobias Schulmann <tobiasschulmann@catalyst.net.nz>
Date: Mon, 12 Dec 2016 12:23:09 +1300
Subject: [PATCH] Middleware changes: * Moved SessionMiddelware to end of
 middleware stack * Added CSRFMiddleware into stack

---
 ckan/config/middleware/pylons_app.py | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/ckan/config/middleware/pylons_app.py b/ckan/config/middleware/pylons_app.py
index 5a1218d4b4..1893b878ec 100644
--- a/ckan/config/middleware/pylons_app.py
+++ b/ckan/config/middleware/pylons_app.py
@@ -60,7 +60,7 @@ def make_pylons_stack(conf, full_stack=True, static_files=True,
     # we want to be able to retrieve the routes middleware to be able to update
     # the mapper.  We store it in the pylons config to allow this.
     config['routes.middleware'] = app
-    app = SessionMiddleware(app, config)
+
     app = CacheMiddleware(app, config)
 
     # CUSTOM MIDDLEWARE HERE (filtered by error handling middlewares)
@@ -125,6 +125,13 @@ def make_pylons_stack(conf, full_stack=True, static_files=True,
         who_parser.remote_user_key
     )
 
+    try:
+        from ckanext.security.middleware import CSRFMiddleware
+        app = CSRFMiddleware(app, config)
+    except ImportError:
+        pass
+    app = SessionMiddleware(app, config)
+
     # Establish the Registry for this application
     app = RegistryManager(app)
 

